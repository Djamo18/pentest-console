<?php
// In PHP versions earlier than 4.1.0, $HTTP_POST_FILES should be used instead
// of $_FILES.


$project= $_GET['project'];
$uploaddir = '/tmp/';
$uploadfile = $uploaddir . 'data.xml';

echo "read project as " . $project . "\n";
echo "dumping file in " . $uploadfile . "\n";

echo '<pre>';
if (move_uploaded_file($_FILES['userfile'][tmp_name], $uploadfile)) {

    echo "File is valid, and was successfully uploaded.\n";

    echo "current directory: " . getcwd() . "\n";
    echo "changing directory\n";

    chdir('/var/www/scripts/wiki_reportgen2');
    echo "current directory: " . getcwd() . "\n";

    echo "cleaning data2 directory\n";
    $last_line = system('rm -rf data2', $retval);
    echo 'return value: ' . $retval . "\n";
    echo 'last line: ' . $last_line;

    echo "making data2 directory\n";
    $last_line = system('mkdir data2', $retval);
    echo 'return value: ' . $retval . "\n";
    echo 'last line: ' . $last_line;

    echo "parsing xml into wiki files\n";
    $last_line = system('perl wiki_reportgen2.pl /tmp/data.xml | tee /tmp/wiki_reportgen2.txt', $retval);
    echo 'return value: ' . $retval . "\n";  
    echo 'last line: ' . $last_line;

    echo "loading data into trac project: " . $project . "\n";
    $command = "trac-admin /var/trac/" . $project . " wiki load data2"; 
    echo $command;
    $last_line = system($command, $retval);
    echo 'return value: ' . $retval . "\n"; 
    echo 'last line: ' . $last_line;

    echo "cleaning data2 directory\n";
    $last_line = system('rm -rf data2', $retval);
    echo 'return value: ' . $retval . "\n";
    echo 'last line: ' . $last_line;

    chdir('/var/www/htdocs');
    echo "current directory: " . getcwd() . "\n";


} else {
    echo "Possible file upload attack!\n";
}
print_r($_FILES);
print "</pre>";


//echo '<SCRIPT LANGUAGE="JavaScript">
//window.location="http://' . $_SERVER["SERVER_ADDR"] . 'progressbar.php"';
//echo '</script>';
?> 
