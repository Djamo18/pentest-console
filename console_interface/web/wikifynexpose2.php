<html>
    <head>
        <script type="text/javascript">
        var prg_width = 200;
 
        function progress() {
            var node = document.getElementById('progress');
            var w    = node.style.width.match(/\d+/);
 
            if (w == prg_width) {
                w = 0;
            }
 
            node.style.width = parseInt(w) + 5 + 'px';
        }
 
        </script>
    </head>
 
    <body onload="var progress_run_id = setInterval(progress, 1000);">
 
        <div style="border: 1px solid black; width:200px; height:5px;">
            <div id="progress" style="height:5px; width:0px; background-color:red;"/>
        </div>
 

<?php
// In PHP versions earlier than 4.1.0, $HTTP_POST_FILES should be used instead
// of $_FILES.

$project= $_POST['project'];
$projectdir = '/tmp/' . $project . '/';
$uploadfile = $projectdir . 'data.xml';
$datadir = $projectdir . 'data2';
$logfile = $projectdir . 'wikireportgen_2.log';

$wikireportgen = '/var/www/scripts/wiki_reportgen2/wiki_reportgen2.pl';
$parsecommand = '/usr/bin/perl ' . $wikireportgen . ' ' . $uploadfile . ' ' .   $datadir . ' | tee ' . $logfile;
$traccommand = "trac-admin /var/trac/" . $project . " wiki load " . $datadir; 

echo '<pre>';

echo "read project as " . $project . "\n";
echo "dumping file in " . $uploadfile . "\n";
echo "parsing into " . $datadir . "\n";
echo "logging into " . $logfile . "\n";
echo "running parsecommand " . $parsecommand . "\n";
echo "running traccommand " . $traccommand . "\n";

echo "removing project directory (just in case)\n";
$last_line = system('rm -rf ' . $projectdir, $retval);

echo "making project directory\n";
$last_line = system('mkdir ' . $projectdir, $retval);

if (move_uploaded_file($_FILES['userfile'][tmp_name], $uploadfile)) {

    echo "File is valid, and was successfully uploaded.\n";
    
    echo "making data2 directory\n";
    $last_line = system('mkdir ' . $datadir, $retval);

    echo "parsing xml into wiki files\n";
    chdir("/var/www/scripts/wiki_reportgen2");
    $last_line = system( $parsecommand , $retval);
    chdir("/tmp");
    echo 'return value: ' . $retval . "\n";   
    echo 'last line: ' . $last_line . "\n";

    echo "loading data into trac project: " . $project . "\n";   
    $last_line = system($traccommand, $retval);
    echo 'return value: ' . $retval . "\n"; 
    echo 'last line: ' . $last_line . "\n";

 //   echo "cleaning project directory\n";
 //   $last_line = system('rm -rf ' . $projectdir, $retval);

} else {
    echo "Possible file upload attack!\n";
    echo "Error code: " .  $_FILES['userfile']['error'] . "\n";

}
print_r($_FILES);
print "</pre>";

//echo '<SCRIPT LANGUAGE="JavaScript">
//window.location="http://' . $_SERVER["SERVER_ADDR"] . 'progressbar.php"';
//echo '</script>';
?> 

    </body>
</html>

