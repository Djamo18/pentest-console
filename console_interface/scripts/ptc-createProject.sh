#!/bin/bash

##if [ $USER!="www-data" ]; then
##   echo  "WARNING: Make sure this script is run by the PTC user..."
##fi 

if [ $# -ne 2 ]; then
   echo "USAGE: $0 [template] [project]"
   exit
fi

TEMPLATE=$1
PROJECT=$2

## Cleanup
echo cleaning up template project...
rm /var/trac/$TEMPLATE/db/*.bak
rm /var/trac/$TEMPLATE/logs/*

## Do TEMPLATE Copy
echo copying template $TEMPLATE...
cp /var/trac/$TEMPLATE /var/trac/$PROJECT -rf
cp /var/svn/$TEMPLATE /var/svn/$PROJECT -rf


## Set configuration - replace configuration files for this project
echo setting configuration...
cat /var/trac/$PROJECT/conf/trac.ini | sed -e s/$TEMPLATE/$PROJECT/g > /var/trac/$PROJECT/conf/trac2.ini
mv /var/trac/$PROJECT/conf/trac2.ini  /var/trac/$PROJECT/conf/trac.ini

## Resync the repository
echo resynching...
trac-admin /var/trac/$PROJECT resync


## Set Perms
chown -R www-data:users /var/trac/$PROJECT
chown -R www-data:users /var/svn/$PROJECT
chmod -R 775 /var/svn/$PROJECT
chmod -R 775 /var/trac/$PROJECT
