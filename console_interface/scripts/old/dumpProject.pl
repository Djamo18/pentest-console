#!/usr/bin/env perl
use strict;
use Getopt::Long;
use File::Copy;

use vars qw( $PROG );
( $PROG = $0 ) =~ s/^.*[\/\\]//;    # Truncate calling path from the prog name

my %options;

sub help {
   print "Usage: $PROG [Options]
[Required Options]
  -o --old [export from project]
  -n --new [import to project]
  -r --regex [regex to parse]
  -h --help [you got it]\n";
}

if (@ARGV == 0){
   help();
   exit;
}

GetOptions(
   \%options,
   'old|o=s','new|n=s','regex|r=s',
   'help|h=s'  => sub { help(); },
   )
   or exit 1;

if ( -e "wikiTemp2"){
    print "WARNING! wikiTemp2 already exists!\n"
}


my $file;

if ( -e "/var/trac/" . $options{old} ){

  if ( -e "wikiTemp"){
     cleanup("wikiTemp");
  }

  mkdir "wikiTemp" or die "Can't make wikiTemp";
  system("trac-admin /var/trac/" . $options{old} . " wiki dump wikiTemp");

  foreach ( glob("wikiTemp/" . $options{regex}) ){
     print "gotcha! " . $_ . "\n";
     copy($_, "wikiTemp2");
  }

  system("trac-admin /var/trac/" . $options{new} . " wiki load wikiTemp");

}

sub cleanup {
        my $dir = shift;
	local *DIR;

	opendir DIR, $dir or die "opendir $dir: $!";
	for (readdir DIR) {
	        next if /^\.{1,2}$/;
	        my $path = "$dir/$_";
		unlink $path if -f $path;
		cleanup($path) if -d $path;
	}
	closedir DIR;
	rmdir $dir or print "error - $!";
}
