#!/bin/bash
###
#
# startEngagement.sh
#
###
#
# Owner: 	jabra
#		jcran
#		
# Purpose: 	Set up a generic Trac Project in var (/var/svn, /var/trac) 
#		This script should be used as the basis for all projects.
#             	Additional (specific) customizations should be made in a follow-up script.
#
# Description: 
#		- Create Subversion Repo & Trac Project based on provided name		
#		- Remove Generic Crap from Trac
#		- Add users
#		- Set permissions on trac directories
#
#
# History:
#		03/15/08 - Script created from start_pentest.sh by jabra (scripts have been split out)
#
#

# Get Arguments
CLIENT=$1
if [ $0 == "sudo" ] ; then
	CLIENT=$2
fi

#echo $CLIENT

# Sanitize Client Name
CLIENT=`echo $CLIENT |perl -p -e 's/\W//g'`

if [ -z $CLIENT  ] ; then
	echo "Client is blank"
	exit 1
fi

# Check if client already exists
if [ -e /var/trac/$CLIENT ] ; then
  echo "The client name already exists.  Archive the old engagement or think of a new name variant."
  exit 2
fi

# Create directories needed
mkdir -p /var/svn
mkdir -p /var/svn/$CLIENT
mkdir -p /tmp/$CLIENT
mkdir -p /tmp/$CLIENT/trunk

# Create Subversion Repo & Initial Structure
svnadmin create /var/svn/$CLIENT
svn import /tmp/$CLIENT file:///var/svn/$CLIENT -m  "initial import"
rm -rf /tmp/$CLIENT

# Create Trac Project
trac-admin /var/trac/$CLIENT initenv $CLIENT sqlite:db/trac.db svn /var/svn/$CLIENT
#chown -R www-data /var/svn/$CLIENT

# TODO wtf
#chmod 777 /var/trac/$CLIENT/conf/trac.ini 
#echo "[components]" >>  /var/trac/$CLIENT/conf/trac.ini
#echo "webadmin.* = enabled" >> /var/trac/$CLIENT/conf/trac.ini
#chmod 644 /var/trac/$CLIENT/conf/trac.ini

# Set configuration - replace example.org in the configuration files for this project
sed -e "s/http:\/\/example.org\//\/projects\/$CLIENT/g" /var/trac/$CLIENT/conf/trac.ini > /var/trac/$CLIENT/conf/trac2.ini
cp /var/trac/$CLIENT/conf/trac.ini  /var/trac/$CLIENT/conf/trac-orig.ini
cp /var/trac/$CLIENT/conf/trac2.ini  /var/trac/$CLIENT/conf/trac.ini
rm /var/trac/$CLIENT/conf/trac2.ini

# Add consultants as admins
trac-admin /var/trac/$CLIENT permission add jabra TRAC_ADMIN
trac-admin /var/trac/$CLIENT permission add dan TRAC_ADMIN
trac-admin /var/trac/$CLIENT permission add willis TRAC_ADMIN
trac-admin /var/trac/$CLIENT permission add pwright TRAC_ADMIN
trac-admin /var/trac/$CLIENT permission add abby TRAC_ADMIN
trac-admin /var/trac/$CLIENT permission add rob TRAC_ADMIN
trac-admin /var/trac/$CLIENT permission add jdaniel TRAC_ADMIN
trac-admin /var/trac/$CLIENT permission add reportgen XML_RPC
trac-admin /var/trac/$CLIENT permission add ptc TICKET_ADMIN
trac-admin /var/trac/$CLIENT permission add ptc XML_RPC

# Remove Anonymous create & modify
trac-admin /var/trac/$CLIENT permission remove anonymous  WIKI_CREATE
trac-admin /var/trac/$CLIENT permission remove anonymous  WIKI_MODIFY
trac-admin /var/trac/$CLIENT permission remove anonymous  TICKET_CREATE
trac-admin /var/trac/$CLIENT permission remove anonymous  TICKET_MODIFY
trac-admin /var/trac/$CLIENT permission remove anonymous  BROWSER_VIEW    
trac-admin /var/trac/$CLIENT permission remove anonymous  CHANGESET_VIEW  
trac-admin /var/trac/$CLIENT permission remove anonymous  FILE_VIEW       
trac-admin /var/trac/$CLIENT permission remove anonymous  LOG_VIEW        
trac-admin /var/trac/$CLIENT permission remove anonymous  MILESTONE_VIEW  
trac-admin /var/trac/$CLIENT permission remove anonymous  REPORT_SQL_VIEW 
trac-admin /var/trac/$CLIENT permission remove anonymous  REPORT_VIEW     
trac-admin /var/trac/$CLIENT permission remove anonymous  ROADMAP_VIEW    
trac-admin /var/trac/$CLIENT permission remove anonymous  SEARCH_VIEW     
trac-admin /var/trac/$CLIENT permission remove anonymous  TEMPLATES_CREATE
trac-admin /var/trac/$CLIENT permission remove anonymous  TEMPLATES_MODIFY
trac-admin /var/trac/$CLIENT permission remove anonymous  TEMPLATES_VIEW  
trac-admin /var/trac/$CLIENT permission remove anonymous  TICKET_VIEW     
trac-admin /var/trac/$CLIENT permission remove anonymous  TIMELINE_VIEW   
trac-admin /var/trac/$CLIENT permission remove anonymous  WIKI_VIEW 

# Remove generic milestones
trac-admin /var/trac/$CLIENT milestone remove "milestone1" 
trac-admin /var/trac/$CLIENT milestone remove "milestone2" 
trac-admin /var/trac/$CLIENT milestone remove "milestone3" 
trac-admin /var/trac/$CLIENT milestone remove "milestone4" 

# Set default priorities
trac-admin /var/trac/$CLIENT priority change major high
trac-admin /var/trac/$CLIENT priority change minor medium
trac-admin /var/trac/$CLIENT priority change trivial low

# Set Permission
chown -R www-data:users /var/trac/$CLIENT
chown -R www-data:users /var/svn/$CLIENT 
chmod -R 775 /var/svn/$CLIENT 
chmod -R 775 /var/trac/$CLIENT 

#Upgrade (because of plugins?)
trac-admin /var/trac/$CLIENT upgrade

# Verify Permissions
chown -R www-data:users /var/trac/$CLIENT
chown -R www-data:users /var/svn/$CLIENT
chmod -R 775 /var/svn/$CLIENT
chmod -R 775 /var/trac/$CLIENT

