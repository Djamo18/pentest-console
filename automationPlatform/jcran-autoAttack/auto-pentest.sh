#!/bin/bash
## Owner: jcran
## Purpose: Automate a pentest's initial work
## Description:
##	1) Gather user input
##	2) Set up environment for automatic pentest
##      3) Kick off auto pentest
##
## Notes: Script should be run from consulting.rapid7.com
##

## Set up Initial Environment
## --------------------------
export AP="1"
export AP_ROOT=`pwd` # assume we're in the base directory (all other scripts exist below this)
export AP_TOOLKIT="/home/$USER/toolkit"
export AP_NMAP_SCRIPT_DIR="scripts/nmap-auto-scripts"

## Gather user options
## --------------------
if [ $# -lt 3 ]; then
	echo "Usage: $0 [projectName] [hostsFile] [hostDomain] [debug]"
	exit -1
fi

## Set User-Based Variables
## -------------------------------------------------------
export AP_PROJECT_NAME="$1"
export AP_HOST_FILE="$2"
export AP_HOST_DOMAIN="$3"
export AP_DEBUG="$4"
export AP_RESULT_DIR="$AP_PROJECT_NAME/results"
export AP_LOG_DIR="$AP_PROJECT_NAME/log"

## Make nececessary directories, if they don't already exist
## ----------------------------------------------------------
if [ ! -e $AP_PROJECT_NAME ] #Main Directory
then
	if [ "$AP_DEBUG" -eq "1" ]
	then	
		echo "Creating Directory Structure"
	fi

	mkdir $AP_PROJECT_NAME	
	mkdir $AP_LOG_DIR
	mkdir $AP_RESULT_DIR
	mkdir $AP_RESULT_DIR/services
fi


## Ensure we can read hosts file
## ----------------------------
if [ -r $2 ]
then
	export AP_HOST_FILE=$2
else
	echo "ERROR: Can't Read Hosts File: $2"
	exit -1
fi

## Ensure we're running w/ root permissions
## ----------------------------------------
if [ `whoami` != root ]; then
        echo Script must be run with root privs
        exit -2
else 
	ant whatever
fi

## DEBUG - Enumerate Environment
## ------------------------------
if [ "$AP_DEBUG" -eq "1" ] 
then
	echo "Setting Debug Level to " $AP_DEBUG
	echo "Setting Base Directory to" $AP_ROOT
	echo "Setting Toolkit Directory to" $AP_TOOLKIT
	echo "Setting Project Name to" $AP_NAME
	echo "Setting Hosts File to" $AP_HOST_FILE
	echo "Setting DNS Domain to" $AP_HOST_DOMAIN
	echo "Setting Results Directory to" $AP_RESULT_DIR
	echo "Setting Log Directory to" $AP_LOG_DIR
	echo "Setting Nmap Script Directory to" $AP_NMAP_SCRIPT_DIR
fi

## Kick off nmap scripts
scripts/nmap-auto-scripts/nmap-auto-pentest.sh

## Start service-specific scans
scripts/ss-auto-scripts/ss-auto-pentest.sh

## Set usable permission
chmod 777 $AP_PROJECT_NAME -R
