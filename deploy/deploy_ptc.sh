#!/bin/bash
#
#
# Owner:		jcran
# Purpose:		deploy new_engagement scripts to correct places (on vmtrac)
# Description:	
#			- Get ptc scripts
#			- Get ptc web pages
#			
# History
#			03/15/08 Initial Creation	
#

## TODO - rethink users group and www-data user - what about letting ptc run the webserver? 
## TODO - think through permissions, and figure how to limit properly
## TODO - clean old directories? should be an option  
## TODO - take a different user as an option
## TODO - read the repo from an option (yaml?)

REPO=vmtrac.bos.rapid7.com/var/svn/PSO_Process/trunk
PTCUSER=www-data
PTCGROUP=users
PERM=775
UPDATE=0


## script must be run as root
if [ ! $USER = 'root'  ]; then 
   echo "must be run as root"
   exit
fi

if [ $1 = "-clean" ]; then 
   echo "removing /var/ptc..."
   rm -rf /var/ptc
   echo "removing /var/www/htdocs..."
   rm -rf /var/www/htdocs
   echo "removing /var/www/scripts..."
   rm -rf /var/www/scripts

   ##note, don't clean up trac,trac-archive,svn, or svn-archive. that should always be done manually. 
   exit
fi

## Create main PTC directory (assumes everything is getting pulled down from SVN)
if [ -d /var/ptc ]; then 
   # update if it exists
   echo "/var/ptc exists"
   if [ $UPDATE -eq 1 ]; then
      echo "updating /var/ptc"
      cd /var/ptc
      svn update -q
   fi
else
   echo "creating main ptc directory - /var/ptc"
   mkdir /var/ptc
   svn co svn+ssh://$USER@$REPO/ptc/ /var/ptc
fi

chown $PTCUSER:$PTCGROUP /var/ptc -R 
chmod $PERM /var/ptc/deploy -R


## Create main trac directory
if [ -d /var/trac ]; then 
   # update if it exists
   echo "/var/trac exists"
else
   echo "creating main trac directory - /var/trac"
   mkdir /var/trac
fi

chown $PTCUSER:$PTCGROUP /var/trac -R 
chmod $PERM /var/trac -R

## egg cache needs to be creatable (not created!) / writable to the web user
## it's def a better idea to move the .egg-cache directory out of /var/trac
## maybe to /tmp or to /var/ptc?

## Create archive trac directory
if [ -d /var/trac-archive ]; then 
   echo "/var/trac-archive exists"
else
   echo "creating archive trac directory - /var/trac-archive"
   mkdir /var/trac-archive
fi

## set perms
chown $PTCUSER:$PTCGROUP /var/trac-archive -R 
chmod 775 /var/trac-archive -R


## Create main svn directory
if [ -d /var/svn ]; then 
   echo "/var/svn exists"
else
   echo "creating main svn directory - /var/svn"
   mkdir /var/svn
fi

chown $PTCUSER:$PTCGROUP /var/svn -R 
chmod $PERM /var/svn -R


## create archive svn directory
if [ -d /var/svn-archive ]; then 
   echo "/var/svn-archive exists"
else
   echo "creating archive svn directory - /var/svn-archive"
   mkdir /var/svn-archive
fi

chown $PTCUSER:$PTCGROUP /var/svn-archive -R 
chmod $PERM /var/svn-archive -R


## script directory (it's a working svn directory)
if [ -d /var/www/scripts ]; then
   # update if it exists already
   echo "/var/www/scripts exists"
   if [ $UPDATE -eq 1 ]; then
      echo "updating scripts directory - /var/www/scripts"
      cd /var/www/scripts
      svn update -q
    fi
else
   echo "creating scripts directory - /var/www/scripts"
   mkdir /var/www/scripts 
   svn co svn+ssh://$USER@$REPO/ptc/console_interface/scripts /var/www/scripts
fi

# get trac parsing scripts
if [ -d /var/www/scripts/wiki_reportgen2 ]; then
   # update if it exists already
   echo "/var/www/scripts/wiki_reportgen2 exists"
   if [ $UPDATE -eq 1 ]; then
      echo "updating wiki reportgen directory - /var/www/scripts/wiki_reportgen2"   
      cd /var/www/scripts/wiki_reportgen2
      svn update -q
   fi
else
   echo "creating wiki reportgen directory - /var/www/scripts/wiki_reportgen2"
   mkdir /var/www/scripts/wiki_reportgen2 
   svn co svn+ssh://$USER@$REPO/wiki_reportgen2 /var/www/scripts/wiki_reportgen2
fi

chown $PTCUSER:$PTCGROUP /var/www/scripts -R 
chmod $PERM /var/www/scripts -R


## web directory (it's a working svn directory)
if [ -d /var/www/htdocs ]; then
   echo "/var/www/htdocs exists"
   # update if it exists already
   if [ $UPDATE -eq 1 ]; then
      echo "updating web directory - /var/www/htdocs"
      cd /var/www/htdocs
      svn update -q
   fi
else
   echo "creating web interface directory - /var/www/htdocs"
   mkdir /var/www/htdocs
   svn co svn+ssh://$USER@$REPO/ptc/console_interface/web /var/www/htdocs
fi

chown $PTCUSER:$PTCGROUP /var/www/htdocs -R 
chmod $PERM /var/www/htdocs -R

## log directory
if [ -d /var/log/ptc ]; then
   echo "/var/log/ptc exists"
   # update if it exists already
else
   echo "creating log directory - /var/log/ptc"
   mkdir /var/log/ptc
fi

chown $PTCUSER:$PTCGROUP /var/log/ptc -R 
chmod $PERM /var/log/ptc -R


