## jcran - 08/05/2009
## These notes will help you set up a clean PentestConsole (ptc) box.

=== Basic Machine Setup ===
 * Start with a base ubuntu server
 * Configure a clean box
   - username: ptc
   - password: ptc

 * Upgrade the machine
  - sudo apt-get update 
  - sudo apt-get upgrade

 * Install ssh server (handy for copy&paste in a vm)
{{{
sudo apt-get install openssh-server
}}}

 * Install python
  - sudo apt-get install python 
{{{
$python --version
Python 2.5.2
}}}

 * Install easy-install
  * For instruction, see: http://peak.telecommunity.com/DevCenter/EasyInstall#installing-easy-install
   * download the egg from http://pypi.python.org/pypi/setuptools
{{{
wget http://pypi.python.org/packages/2.5/s/setuptools/setuptools-0.6c9-py2.5.egg
}}}
   * run the script
{{{
sudo sh setuptools-0.6c9-py2.5.egg
}}}

 * Install SQLite
  * sudo apt-get install sqlite		     # regular SQLite	
  * sudo apt-get install python-sqlite       # pysqlite 1.0 
  * sudo apt-get install python-pysqlite1.1  # pysqlite 1.1
  * sudo apt-get install python-pysqlite2    # pysqlite 2.x

=== Apache Install ===

 * Install apache
{{{
sudo apt-get install apache2
sudo apt-get install apache2-ssl
sudo apt-get install libapache2-mod-python libapache2-mod-python-doc
}}}

 * Enable mod_python
{{{
a2enmod python
}}}

 * set up SSL 
  * (blatently stolen from: http://edin.no-ip.com/content/apache-https-redirect-debian-mini-howto)
{{{
sudo apt-get install ssl-cert
}}}

  * Gen the cert
{{{
mkdir -p /etc/apache2/ssl
make-ssl-cert /usr/share/ssl-cert/ssleay.cnf /etc/apache2/ssl/apache.pem
}}}
  * Link the module for activation
{{{
ln -s /etc/apache2/mods-available/ssl.* /etc/apache2/mods-enabled/
}}}
  * edit /etc/apache2/ports.conf to enable :443
{{{
Listen 80
Listen 443
}}}
  * enable mod-rewrite
{{{
ln -s /etc/apache2/mods-available/rewrite.load /etc/apache2/mods-enabled/
}}}

  * create trac apache config
{{{
sudo cp /etc/apache2/sites-available/default trac
sudo ln -s 001-trac /etc/apache2/sites-available/trac
sudo rm /etc/apache2/sites-enabled/000-default
}}}

 * make the /etc/sites-available/trac file look like:
{{{
TODO
}}}

 * install php
{{{
sudo apt-get install php5
}}

 * set php to accept large file-uploads (/etc/php5/apache2/php.ini?) [http://www.radinks.com/upload/config.php]
{{{
;;;;;;;;;;;;;;;;
; File Uploads ;
;;;;;;;;;;;;;;;;

; Whether to allow HTTP file uploads.
file_uploads = On

; Temporary directory for HTTP uploaded files (will use system default if not
; specified).
;upload_tmp_dir =

; Maximum allowed size for uploaded files.
upload_max_filesize = 20M

;;;;;;;;;;;;;;;;;;;
; Resource Limits ;
;;;;;;;;;;;;;;;;;;;

max_execution_time = 30     ; Maximum execution time of each script, in seconds
max_input_time = 90 ; Maximum amount of time each script may spend parsing request data
;max_input_nesting_level = 64 ; Maximum input variable nesting level
memory_limit = 16M      ; Maximum amount of memory a script may consume (16MB)

; Maximum size of POST data that PHP will accept.
post_max_size = 20M


}}}

}
 * restart apache (php)



=== Trac Install ===
 * Install trac 0.11
  * http://trac.edgewall.org/wiki/TracInstall
{{{
sudo easy_install Trac
}}}

 * Install subversion & friends
{{{
sudo apt-get install subversion
sudo apt-get install swig  ## not sure if this is necessary
sudo apt-get install python-subversion
}}}


=== PTC Prep ===
 * Make critical system directories
{{{
sudo mkdir /var/www/empty
sudo mkdir /var/www/scripts
sudo mkdir /var/www/htdocs
sudo mkdir /var/trac
sudo mkdir /var/svn
}}}


 * Create ptc web user
{{{
sudo htpasswd -c -s /var/trac/.htaccess ptc
}}}

 * Create & Edit default trac.ini file
{{{ 
sudo mkdir /etc/trac
sudo touch /etc/trac/trac.ini
}}}
  * make it look like: 
{{{
[attachment]
max_size = 262144
render_unsafe_content = false

[browser]
downloadable_paths = /trunk, /branches
hide_properties = svk:merge
render_unsafe_content = false

[changeset]
max_diff_bytes = 10000000
max_diff_files = 0
wiki_format_messages = true

[header_logo]
alt = 
height = -1
link = https://ptc/
src = common/trac_banner.png
width = -1

##[logging]
##log_file = trac.log
## log_format = <set in global trac.ini>
##log_level = DEBUG
##log_type = none

[mimeviewer]
enscript_modes = text/x-dylan:dylan:4
enscript_path = enscript
max_preview_size = 262144
mime_map = text/x-dylan:dylan,text/x-idl:ice,text/x-ada:ads:adb
php_path = php
silvercity_modes = 
tab_width = 8

##[notification]
##always_notify_owner = false
##always_notify_reporter = false
##always_notify_updater = true
##mime_encoding = base64
##smtp_always_bcc =
##smtp_always_cc = 
##smtp_default_domain = rapid7.com
##smtp_enabled = true
##smtp_from = noreply@vmtrac.bos.rapid7.com
##smtp_password = 
##smtp_port = 25
##smtp_replyto = noreply@vmtrac.bos.rapid7.com
##smtp_server = localhost
##smtp_subject_prefix = __default__
##smtp_user = 
##use_public_cc = false
##use_short_addr = false
##use_tls = false

##[project]
##descr = rapid7 project
##footer = Visit the Trac open source project at<br /><a href="http://trac.edgewall.org/">http://trac.edgewall.org/</a>
##icon = common/trac.ico
##url = http://example.org/

[inherit]
plugins_dir = /usr/lib/python2.5/site-packages/

[search]
min_query_length = 3

[ticket]
default_component = 
default_milestone = 
default_priority = medium
default_type = task
default_version = 
restrict_owner = false

[timeline]
changeset_long_messages = true
changeset_show_files = 1
default_daysback = 60
ticket_show_details = true

[trac]
authz_file = 
authz_module_name = 
base_url = https://ptc 
check_auth_ip = true
database = sqlite:db/trac.db
default_charset = iso-8859-15
default_handler = WikiModule
htdocs_location = 
ignore_auth_case = false
mainnav = wiki,timeline,roadmap,browser,tickets,newticket,search
metanav = login,logout,settings,help,about
permission_store = DefaultPermissionStore
repository_type = svn
timeout = 20

[wiki]
ignore_missing_pages = false
render_unsafe_content = false
split_page_names = false

[components]
webadmin.* = enabled
tracrpc.* = enabled
autocompleteusers.* = enabled
advancedworkflow.* = enabled
TracSubPages.* = enabled
tracnav.* = enabled
announcerplugin.* = enabled
announcerplugin.subscribers.ticket_groups.* = disabled
breadcrumbsnavplugin.* = enabled
ticket_clone.* = enabled
customfieldadmin.* = enabled
includemacro.* = enabled
tracwysiwyg.* = enabled
svnpolicies.* = enabled
revtree.* = enabled

[intertrac]
# -- alias
tk = toolkit
tmp = templates
# -- Link to an external Trac:

toolkit.title = toolkit
toolkit.url = https://ptc/projects/toolkit
templates.title = templates
templates.url = https://ptc/projects/templates

##[ticket-custom]
##templatefinding = select
##templatefinding.label = Template Finding
##templatefinding.options = |passthehash|bestpractice-activedirectory|whatever|web-sqlinjection|web-xss|web-session
##templatefinding.order = 0

##damagepotential = select
##damagepotential.label = Damage Potential
##damagepotential.options = |0|1|2|3|4|5|6|7|8|9|10
##damagepotential.order = 1

##reproducibility = select
##reproducibility.label = Reproducibility
##reproducibility.options = |0|1|2|3|4|5|6|7|8|9|10
##reproducibility.order = 2

##exploitability = select
##exploitability.label = Exploitability
##exploitability.options = |0|1|2|3|4|5|6|7|8|9|10
##exploitability.order = 3

##affectedusers = select
##affectedusers.label = Affected Users
##affectedusers.options = |0|1|2|3|4|5|6|7|8|9|10
##affectedusers.order = 4

##discoverability = select
##discoverability.label = Discoverability
##discoverability.options = |0|1|2|3|4|5|6|7|8|9|10
##discoverability.order = 5

##proof = textarea
##proof.label = Proof
##proof.cols = 120
##proof.rows = 6
##proof.format = wiki
##proof.order = 6

##recommendations = textarea
##recommendations.label = Recommendations
##recommendations.cols = 120
##recommendations.rows = 6
##recommendations.format = wiki
##recommendations.order = 7

##references = textarea
##references.label = References (One Per Line)
##references.cols = 120
##references.rows = 6
##references.format = wiki
##references.order = 8
}}}

=== Trac Plugin Setup ===
The plugins below are downloaded from svn and installed into /usr/lib/python2.5/site-packages/. Note that the trac.ini file below has a plugins_dir setting which specifies this.

Do this as root (sudo -s)

 * xmlrpc - http://trac-hacks.org/wiki/XmlRpcPlugin
{{{
 easy_install -Z -U http://trac-hacks.org/svn/xmlrpcplugin/trunk
}}}
 * autocompleteusers - http://trac-hacks.org/wiki/AutocompleteUsersPlugin
{{{
easy_install http://trac-hacks.org/svn/autocompleteusersplugin/
}}}
 * advancedticketworkflow - http://trac-hacks.org/wiki/AdvancedTicketWorkflowPlugin
{{{
easy_install http://trac-hacks.org/svn/sdvancedticketworkflowplugin/0.11
}}}
 * tracsubpages - http://trac-hacks.org/wiki/TracSubPagesMacro
{{{
easy_install TracSubPages
}}}
 * tracnav - http://svn.ipd.uka.de/trac/javaparty/wiki/TracNav
{{{
easy_install TracNav
}}}
 * announcer
{{{
easy_install http://trac-hacks.org/svn/announcerplugin/0.11
}}}
 * breadcrumbs
{{{
easy_install http://trac-hacks.org/svn/breadcrumbsnavplugin/0.11
}}}
 * ticket-clone
{{{
cd /usr/lib/python2.5/site-packages
wget http://trac.edgewall.org/browser/trunk/sample-plugins/ticket_clone.py
}}}
 * includemacro
{{{
easy_install http://trac-hacks.org/svn/includemacro/0.11
}}}
 * Menus Plugin
{{{
easy_install http://trac-hacks.org/svn/menusplugin/0.11
}}}
 * wsysiwyg
{{{
easy_install http://trac-hacks.org/svn/tracwysiwygplugin/0.11 
}}}
 * Svn policies
{{{
 easy_install http://trac-hacks.org/svn/tracsvnpoliciesplugin/0.11/
}}}

=== Configure PTC Default Projects ===
 * Place the template projects directories into /var/svn and /var/trac (Subversion?)
 * Place the web files into /var/www (Subversion?)


=== TODO set up apache ===
{{{
<VirtualHost 10.1.90.135:80>
      ServerName vmtrac.bos.rapid7.com
      DocumentRoot /var/www/empty/
      RedirectPermanent / https://vmtrac.bos.rapid7.com/
</VirtualHost>

<VirtualHost 10.1.90.135:443 >
    DocumentRoot /var/www/htdocs/
    ServerName vmtrac.bos.rapid7.com

    SSLEngine On
    SSLCertificateFile /etc/ssl/certs/vmtrac.pem
    <Location />
        # any /svn/foo URL will map to a repository /var/svn/foo
        # I've only got it working using SVNPath!!
        AuthType Basic
        AuthName "PSO Engagement Trac"
        AuthUserFile /var/svn/.htaccess
        Require valid-user
    </Location>


DirectoryIndex index.php
<Location /projects>
  SetHandler mod_python
  PythonInterpreter main_interpreter
  PythonHandler trac.web.modpython_frontend 
  PythonOption TracEnvParentDir /var/trac
  PythonOption TracUriRoot /projects
</Location>

    <LocationMatch "/projects/login">
        AuthType Basic
        AuthName "Trac"
        AuthUserFile /var/svn/.htaccess
        Require valid-user
    </LocationMatch>

    <LocationMatch /trac/>
        SetHandler None
    </LocationMatch>

    # Subversion
    <Location /svn>
        DAV svn
        # any /svn/foo URL will map to a repository /var/svn/foo
        # I've only got it working using SVNPath!!
        SVNParentPath /var/svn
        AuthType Basic
        AuthName "Subversion repository"
        AuthUserFile /var/svn/.htaccess
        Require valid-user
    </Location>
    ErrorLog /var/log/apache2/trac/logs/error.log

</VirtualHost>
}}}
